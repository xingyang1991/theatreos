# TheatreOS v1.3 E2E 体验闭环测试报告

**版本:** v1.3-alpha  
**测试日期:** 2025-12-26  
**测试人员:** Manus AI

## 1. 测试目标

本次测试旨在完成 TheatreOS E2E (End-to-End) 体验闭环的前后端 API 对齐和功能验证，确保核心用户流程 "看戏→押门→结算→归档→追证→复访" 的基础功能可用性和数据连贯性。

## 2. 测试环境

- **服务器:** 阿里云 ECS (http://120.55.162.182)
- **前端:** v1.3-alpha 分支
- **后端:** v1.3-alpha 分支
- **数据库:** 后端服务自带的 SQLite 数据库 (非本地 sandbox 数据库)

## 3. E2E 核心流程验证

通过模拟用户完整体验路径，验证核心功能的连通性。

| 步骤 | 流程 | 页面/功能 | API 状态 | 数据来源 | 验证结果 |
| :--- | :--- | :--- | :--- | :--- | :--- |
| 1 | 看戏 | Showbill / StageLive | ✅ 已对齐 | **真实API** | 正常显示戏单、场景内容和播放进度 |
| 2 | 押门 | GateLobby | ✅ 已对齐 | **真实API** | 正常显示门、投票结果、选项 |
| 3 | 结算 | ExplainCard | ✅ 已对_齐 | **真实API** | 正常显示解释卡、获胜选项、后果 |
| 4 | 归档 | Archive | ⚠️ **未对齐** | **模拟数据** | 页面正常显示，但数据为前端 mock |
| 5 | 追证 | Crew | ⚠️ **未对齐** | **模拟数据** | 页面正常显示，但数据为前端 mock |
| 6 | 复访 | Map | ⚠️ **未对齐** | **模拟数据** | 页面正常显示，但数据为前端 mock |

**结论:** 核心的 "看戏→押门→结算" 流程已实现 E2E 闭环，数据在前后端正确流转。归档、追证、复访等 P1 级别功能的前端 UI 已完成，但尚未与后端 API 对齐，目前使用模拟数据展示。

## 4. API 对齐状态详述

| 模块 | API 端点 (前端调用) | 后端对齐状态 | 备注 |
| :--- | :--- | :--- | :--- |
| **Showbill** | `/v1/theatres/{id}/showbill` | ✅ 已对齐 | `slot_routes.py` 中存在占位逻辑，当数据库无 `HourPlan` 时返回模拟数据。已通过 `demo-cycle` API 创建 `HourPlan` 解决。 |
| **GateLobby** | `/v1/slots/{slot_id}/gate` | ✅ 已对齐 | 成功获取 gate 实例并展示。 |
| **Gate Vote** | `/v1/gates/{id}/vote` | ✅ 已对齐 | 业务逻辑正常（已结束的门无法投票）。 |
| **ExplainCard** | `/v1/gates/{id}/explain` | ✅ 已对齐 | 成功获取解释卡数据。 |
| **Archive** | `/v1/me/archive` | ⚠️ **未对齐** | 前端调用 `/v1/me/archive`，后端无此路由。页面使用 `mockArchiveData`。 |
| **Crew** | `/v1/me/crew` | ⚠️ **未对齐** | 前端调用 `/v1/me/crew`，后端实际为 `/v1/users/{user_id}/crew`。页面使用 `mockCrewData`。 |
| **Map** | (未找到API调用) | ⚠️ **未对齐** | 页面使用 `mockMapData`。 |

## 5. 已发现问题

1.  **P1 功能 API 未对齐**: `Archive`, `Crew`, `Map` 页面的前端组件已开发完成，但其数据来源均为本地 mock 数据，对应的后端 API 尚未完全对齐或前端尚未调用。
2.  **`slot_id` 格式不一致问题**: 前端 showbill 页面在数据库没有 `HourPlan` 数据时，会生成 `slot_YYYYMMDD_HHMM` 格式的占位数据，而后端 `demo-cycle` 创建的真实 `HourPlan` 使用的是 `W1_D4_1700` 格式。这导致了初期测试的混乱。**此问题已通过调用 `demo-cycle` API 创建真实数据绕过，但建议统一 `slot_id` 生成逻辑。**
3.  **开发环境数据库不一致**: 本地 sandbox 环境的数据库 (`theatreos_demo.db`) 与后端服务实际使用的数据库不一致，导致本地修改无法在测试中生效。所有测试必须通过 API 与服务器交互。

## 6. 结论与建议

TheatreOS v1.3-alpha 版本的核心 E2E 流程已基本打通，P0 级别的功能（看戏、押门、结算）前后端 API 已对齐，功能可用。当前版本已达到可演示（Demo）状态。

**建议:**
1.  **优先对齐 P1 功能 API**: 集中开发资源，完成 `Archive`, `Crew`, `Map` 页面的后端 API 对齐工作，替换前端的 mock 数据，以实现完整的 E2E 体验闭环。
2.  **统一 `slot_id` 生成逻辑**: 统一前后端（包括占位逻辑和真实数据逻辑）的 `slot_id` 生成和解析规则，避免未来再次出现数据不匹配问题。
3.  **提供测试数据生成工具**: 为前端开发和测试提供更便捷的后端数据生成工具或 API，避免因数据库不一致导致开发和测试效率降低。
